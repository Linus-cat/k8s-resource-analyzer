<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K8s资源使用率分析工具</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        h1 { color: #333; margin-bottom: 20px; }
        h2 { color: #555; margin: 20px 0 10px; font-size: 18px; }
        
        .card { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        .tabs { display: flex; border-bottom: 2px solid #eee; margin-bottom: 20px; }
        .tab { padding: 12px 24px; cursor: pointer; border: none; background: none; font-size: 16px; color: #666; }
        .tab.active { color: #007bff; border-bottom: 2px solid #007bff; margin-bottom: -2px; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f9f9f9; font-weight: 600; }
        
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; margin-right: 8px; }
        .btn-primary { background: #007bff; color: white; }
        .btn-primary:hover { background: #0056b3; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-sm { padding: 4px 8px; font-size: 12px; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #555; }
        input[type="text"], input[type="number"] { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        
        .upload-area { border: 2px dashed #ddd; padding: 40px; text-align: center; border-radius: 8px; cursor: pointer; }
        .upload-area:hover { border-color: #007bff; }
        .upload-area.dragover { border-color: #007bff; background: #f0f8ff; }
        
        .checkbox-list { max-height: 300px; overflow-y: auto; border: 1px solid #eee; padding: 10px; }
        .checkbox-item { padding: 8px; border-bottom: 1px solid #f5f5f5; }
        .checkbox-item:last-child { border-bottom: none; }
        
        .alert { padding: 12px; border-radius: 4px; margin-bottom: 15px; }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-error { background: #f8d7da; color: #721c24; }
        
        .rate-high { color: #dc3545; font-weight: bold; }
        .rate-medium { color: #ffc107; font-weight: bold; }
        .rate-low { color: #28a745; }
        
        .hidden { display: none; }
        
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { background: white; max-width: 500px; margin: 100px auto; padding: 20px; border-radius: 8px; }
        .modal-content h3 { margin-top: 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>K8s资源使用率分析工具</h1>
        
        <div class="tabs">
            <button class="tab active" data-tab="quota" title="管理项目级配额，限制项目的总CPU和内存使用量">项目配额管理</button>
            <button class="tab" data-tab="namespace-quota" title="管理命名空间级配额，显示CPU、内存、存储、Pod等资源限制和已使用量">命名空间配额</button>
            <button class="tab" data-tab="report" title="上传日报文件，系统将解析文件并计算项目资源使用率，支持多文件批量上传">日报上传</button>
            <button class="tab" data-tab="view" title="查看已上传的日报数据，按日期筛选显示各项目的CPU和内存使用率">报表查看</button>
            <button class="tab" data-tab="export" title="导出Excel报告，选择多个日期生成汇总报表，支持主键/周期/利用率格式">导出</button>
            <button class="tab" data-tab="scheduler" title="配置定时任务，自动在指定时间从K8s API同步配额和从Prometheus同步使用数据">定时任务</button>
            <button class="tab" data-tab="k8s" title="配置K8s集群连接信息，用于从Kubernetes API获取命名空间配额，支持批量导入多个集群">K8s接入</button>
            <button class="tab" data-tab="prometheus" title="配置Prometheus连接，用于查询资源使用数据，支持批量导入多个Prometheus实例">Prometheus接入</button>
        </div>
        
        <div id="quota" class="tab-content active">
            <div class="card">
                <h2>从K8s同步项目配额</h2>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="quotaSelectAll" onchange="toggleAllQuotaClusters(this.checked)"> 
                        <strong>全选</strong>
                    </label>
                    <div id="quotaK8sClusterList" style="max-height:150px;overflow-y:auto;border:1px solid #ddd;padding:10px;">
                        <!-- 集群列表将通过JS加载 -->
                    </div>
                </div>
                <button class="btn btn-primary" onclick="syncProjectQuotaFromK8s()">同步项目配额</button>
                <div id="quotaSyncResult"></div>
            </div>
            
            <div class="card">
                <h2>导入配额</h2>
                <div class="form-group">
                    <input type="file" id="quotaFile" accept=".xlsx" style="display: none;">
                    <button class="btn btn-primary" onclick="document.getElementById('quotaFile').click()">选择Excel文件</button>
                    <button class="btn btn-success" onclick="importQuota()">导入</button>
                    <button class="btn btn-secondary" onclick="downloadQuotaTemplate()">下载模板</button>
                </div>
                <div id="quotaImportResult"></div>
            </div>
            
            <div class="card">
                <h2>配额列表</h2>
                <table>
                    <thead>
                        <tr>
                            <th>云序号</th>
                            <th>项目名称</th>
                            <th>CPU配额(核)</th>
                            <th>内存配额(GB)</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="quotaTable"></tbody>
                </table>
            </div>
        </div>
        
        <div id="editModal" class="modal hidden">
            <div class="modal-content">
                <h3>修改配额</h3>
                <div class="form-group">
                    <label>云序号:</label>
                    <input type="text" id="editCloudId" readonly>
                </div>
                <div class="form-group">
                    <label>项目名称:</label>
                    <input type="text" id="editProjectName">
                </div>
                <div class="form-group">
                    <label>CPU配额(核):</label>
                    <input type="number" id="editCpuQuota" step="0.1">
                </div>
                <div class="form-group">
                    <label>内存配额(GB):</label>
                    <input type="number" id="editMemoryQuota" step="0.1">
                </div>
                <div class="form-group">
                    <button class="btn btn-success" onclick="saveQuota()">保存</button>
                    <button class="btn btn-secondary" onclick="closeModal()">取消</button>
                </div>
            </div>
        </div>
        
        <div id="namespace-quota" class="tab-content">
            <div class="card">
                <h2>从K8s同步命名空间配额</h2>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="nsQuotaSelectAll" onchange="toggleAllNsQuotaClusters(this.checked)"> 
                        <strong>全选</strong>
                    </label>
                    <div id="nsQuotaK8sClusterList" style="max-height:150px;overflow-y:auto;border:1px solid #ddd;padding:10px;">
                        <!-- 集群列表将通过JS加载 -->
                    </div>
                </div>
                <button class="btn btn-primary" onclick="syncNsQuotaFromK8s()">同步命名空间配额</button>
                <div id="nsQuotaSyncResult"></div>
            </div>
            
            <div class="card">
                <h2>手动导入命名空间配额</h2>
                <div class="form-group">
                    <input type="file" id="nsQuotaFile" accept=".xlsx" style="display: none;">
                    <button class="btn btn-success" onclick="document.getElementById('nsQuotaFile').click()">选择Excel文件</button>
                    <button class="btn btn-success" onclick="importNsQuota()">导入</button>
                    <button class="btn btn-secondary" onclick="downloadNsQuotaTemplate()">下载模板</button>
                </div>
                <div id="nsQuotaImportResult"></div>
            </div>
            
            <div class="card">
                <h2>命名空间配额列表</h2>
                <div class="form-group">
                    <label>筛选集群:</label>
                    <select id="nsQuotaFilterCluster" onchange="loadNamespaceQuotas()" style="padding:8px;">
                        <option value="">全部</option>
                    </select>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>集群</th>
                            <th>命名空间</th>
                            <th>项目</th>
                            <th>CPU配额</th>
                            <th>CPU已用</th>
                            <th>CPU使用率</th>
                            <th>内存配额</th>
                            <th>内存已用</th>
                            <th>内存使用率</th>
                            <th>Pod配额</th>
                            <th>Pod已用</th>
                            <th>存储配额</th>
                            <th>存储已用</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="nsQuotaTable"></tbody>
                </table>
            </div>
        </div>
        
        <div id="report" class="tab-content">
            <div class="card">
                <h2>上传日报文件</h2 class="form-group>
                <div">
                    <button class="btn btn-secondary" onclick="downloadReportTemplate()">下载模板</button>
                </div>
                <div class="upload-area" id="uploadArea">
                    <p>点击选择文件或将文件拖放到此处</p>
                    <p style="color: #999; font-size: 12px; margin-top: 10px;">支持上传多个文件，文件名需包含日期 (如: mm_Day_report_2026-02-09.txt)</p>
                    <input type="file" id="reportFiles" multiple accept=".txt,.csv" style="display: none;">
                </div>
                <div id="uploadResult" style="margin-top: 15px;"></div>
            </div>
            
            <div class="card">
                <h2>已上传的日报</h2>
                <div id="reportList"></div>
            </div>
        </div>
        
        <div id="view" class="tab-content">
            <div class="card">
                <h2>选择日期查看报表</h2>
                <div class="form-group">
                    <select id="viewDateSelect" onchange="loadReport()">
                        <option value="">请选择日期</option>
                    </select>
                </div>
            </div>
            
            <div class="card">
                <h2>使用率统计</h2>
                <table>
                    <thead>
                        <tr>
                            <th>云序号</th>
                            <th>项目名称</th>
                            <th>CPU使用量(核)</th>
                            <th>内存使用量(GB)</th>
                            <th>CPU使用率(%)</th>
                            <th>内存使用率(%)</th>
                        </tr>
                    </thead>
                    <tbody id="reportTable"></tbody>
                </table>
            </div>
        </div>
        
        <div id="export" class="tab-content">
            <div class="card">
                <h2>导出Excel报告</h2>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="exportSelectAll" onchange="toggleAllExportDates(this.checked)"> 
                        <strong>全选</strong>
                    </label>
                    <div class="checkbox-list" id="exportDateList"></div>
                </div>
                <button class="btn btn-success" onclick="exportReport()">导出Excel</button>
            </div>
        </div>
        
        <div id="scheduler" class="tab-content">
            <div class="card">
                <h2 title="配置定时任务，自动同步K8s集群配额和Prometheus使用数据">定时任务配置</h2>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="schedulerEnabled">
                        启用定时任务
                    </label>
                </div>
                <div class="form-group">
                    <label>命名空间配额同步时间 (小时):</label>
                    <input type="number" id="schedulerNsQuotaHour" min="0" max="23" value="2">
                    <small style="color:#666;">每天几点执行命名空间配额同步</small>
                </div>
                <div class="form-group">
                    <label>Prometheus同步时间 (小时):</label>
                    <input type="number" id="schedulerPrometheusHour" min="0" max="23" value="3">
                    <small style="color:#666;">每天几点执行Prometheus数据同步</small>
                </div>
                <div class="form-group">
                    <label>同步间隔 (小时):</label>
                    <input type="number" id="schedulerInterval" min="1" max="168" value="24">
                    <small style="color:#666;">定时任务检查间隔（当前未使用）</small>
                </div>
                <button class="btn btn-primary" onclick="saveSchedulerConfig()">保存配置</button>
                <div id="schedulerResult"></div>
            </div>
            
            <div class="card">
                <h2>定时任务说明</h2>
                <ul style="margin-left:20px;color:#666;">
                    <li>命名空间配额同步: 每天在指定时间从K8s API获取所有命名空间的ResourceQuota信息</li>
                    <li>Prometheus同步: 每天在指定时间从Prometheus查询各命名空间的资源使用量</li>
                    <li>需要先配置K8s集群和Prometheus才能使用定时任务</li>
                </ul>
            </div>
        </div>
        
        <div id="k8s" class="tab-content">
            <div class="card">
                <h2 title="配置K8s集群连接信息，用于从Kubernetes API同步命名空间配额">添加K8s集群配置</h2>
                <div class="form-group">
                    <label title="集群名称，用于标识">集群名称:</label>
                    <input type="text" id="k8sName" placeholder="例如: prod-cluster">
                </div>
                <div class="form-group">
                    <label title="Kubeconfig文件内容">Kubeconfig:</label>
                    <textarea id="k8sKubeconfig" rows="6" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;" placeholder="粘贴kubeconfig内容"></textarea>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="k8sUseProjectQuota" checked>
                        使用ProjectQuota (取消则使用Namespace ResourceQuota)
                    </label>
                </div>
                <button class="btn btn-primary" onclick="addK8sConfig()">添加</button>
            </div>
            
            <div class="card">
                <h2>K8s集群列表</h2>
                <table>
                    <thead>
                        <tr>
                            <th>集群名称</th>
                            <th>配额类型</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="k8sConfigTable"></tbody>
                </table>
            </div>
            
            <div class="card">
                <h2 title="批量导入K8s集群配置，支持Excel文件一次性添加多个集群">批量导入集群配置</h2>
                <div class="form-group">
                    <input type="file" id="k8sImportFile" accept=".xlsx" style="display: none;">
                    <button class="btn btn-success" onclick="document.getElementById('k8sImportFile').click()">选择Excel文件</button>
                    <button class="btn btn-success" onclick="importK8sConfigs()">导入</button>
                    <button class="btn btn-secondary" onclick="downloadK8sTemplate()">下载模板</button>
                </div>
                <div id="k8sImportResult"></div>
            </div>
        </div>
        
        <div id="prometheus" class="tab-content">
            <div class="card">
                <h2 title="配置Prometheus连接，用于从Prometheus查询资源使用数据">添加Prometheus配置</h2>
                <div class="form-group">
                    <label title="配置名称">配置名称:</label>
                    <input type="text" id="prometheusName" placeholder="例如: prod-prometheus">
                </div>
                <div class="form-group">
                    <label title="Prometheus API地址">Prometheus URL:</label>
                    <input type="text" id="prometheusUrl" placeholder="例如: http://prometheus:9090">
                </div>
                <div class="form-group">
                    <label title="对应的K8s集群名称">关联集群:</label>
                    <input type="text" id="prometheusCluster" placeholder="与K8s配置中的集群名称一致">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="prometheusAccurate">
                        精确同步 (根据副本数去重，适合滚动更新场景)
                    </label>
                </div>
                <button class="btn btn-primary" onclick="addPrometheusConfig()">添加</button>
            </div>
            
            <div class="card">
                <h2>Prometheus配置列表</h2>
                <table>
                    <thead>
                        <tr>
                            <th>名称</th>
                            <th>URL</th>
                            <th>集群</th>
                            <th>同步模式</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="prometheusConfigTable"></tbody>
                </table>
            </div>
            
            <div class="card">
                <h2 title="批量导入Prometheus配置，支持Excel文件批量添加">批量导入配置</h2>
                <div class="form-group">
                    <input type="file" id="prometheusImportFile" accept=".xlsx" style="display: none;">
                    <button class="btn btn-success" onclick="document.getElementById('prometheusImportFile').click()">选择Excel文件</button>
                    <button class="btn btn-success" onclick="importPrometheusConfigs()">导入</button>
                    <button class="btn btn-secondary" onclick="downloadPrometheusTemplate()">下载模板</button>
                </div>
                <div id="prometheusImportResult"></div>
            </div>
            
            <div class="card">
                <h2 title="PromQL查询规则说明，用于理解数据来源">PromQL查询规则说明</h2>
                <div style="font-size:13px;color:#666;">
                    <details>
                        <summary style="cursor:pointer;color:#007bff;">点击查看PromQL规则</summary>
                        <div style="margin-top:10px;padding:10px;background:#f5f5f5;border-radius:4px;">
                            <p><strong>CPU使用量查询（按Pod聚合的峰值求和）:</strong></p>
                            <code style="display:block;background:#fff;padding:8px;border-radius:4px;margin:5px 0;word-break:break-all;">sum(max by (pod_name)(max_over_time((irate(container_cpu_usage_seconds_total{namespace="$i",container!="",container!="POD"}[5m]))[1d:])))</code>
                            <p style="margin-top:8px;"><strong>说明:</strong> 使用irate计算5分钟内的CPU增长率，再用max_over_time取1天内的最大值，按pod聚合后求和。避免滚动更新时新旧副本交替导致的数据抖动。</p>
                            
                            <p style="margin-top:15px;"><strong>内存使用量查询（按Pod聚合的峰值求和）:</strong></p>
                            <code style="display:block;background:#fff;padding:8px;border-radius:4px;margin:5px 0;word-break:break-all;">sum(max by (pod_name)(max_over_time(container_memory_usage_bytes{namespace="$i",container!="",container!="POD"}[1d])))</code>
                            <p style="margin-top:8px;"><strong>说明:</strong> 使用container_memory_usage_bytes获取内存使用量，用max_over_time取1天内的最大值，按pod聚合后求和。避免内存瞬时波动影响判断。</p>
                            
                            <p style="margin-top:15px;"><strong>精确同步模式:</strong></p>
                            <p>根据K8s API获取的期望副本数(replicas)对Prometheus数据进行去重处理，公式: 实际值 × (期望副本数 / 实际Pod数)</p>
                            <p>适用于滚动更新期间，避免新旧副本交替导致的数据偏高</p>
                        </div>
                    </details>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = '/api';
        
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
                
                if (tab.dataset.tab === 'quota') loadQuotas();
                if (tab.dataset.tab === 'namespace-quota') loadNamespaceQuotas();
                if (tab.dataset.tab === 'report') loadReports();
                if (tab.dataset.tab === 'view') loadViewDates();
                if (tab.dataset.tab === 'export') loadExportDates();
                if (tab.dataset.tab === 'scheduler') loadSchedulerConfig();
                if (tab.dataset.tab === 'k8s') loadK8sConfigs();
                if (tab.dataset.tab === 'prometheus') loadPrometheusConfigs();
            });
        });
        
        async function loadQuotas() {
            const res = await fetch(`${API_BASE}/quotas`);
            const quotas = await res.json();
            const tbody = document.getElementById('quotaTable');
            tbody.innerHTML = quotas.map(q => `
                <tr>
                    <td>${q.cloud_id}</td>
                    <td>${q.project_name}</td>
                    <td>${q.cpu_quota}</td>
                    <td>${q.memory_quota}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editQuota('${q.cloud_id}', '${q.project_name}', ${q.cpu_quota}, ${q.memory_quota})">修改</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteQuota('${q.cloud_id}')">删除</button>
                    </td>
                </tr>
            `).join('');
            
            // Load K8s clusters for sync
            await loadK8sClustersForQuotaSync();
        }
        
        async function loadK8sClustersForQuotaSync() {
            const res = await fetch(`${API_BASE}/k8s/configs`);
            const configs = await res.json();
            
            const quotaList = document.getElementById('quotaK8sClusterList');
            const nsQuotaList = document.getElementById('nsQuotaK8sClusterList');
            
            const checkboxHtml = configs.map(c => `
                <div style="margin:5px 0;">
                    <label><input type="checkbox" value="${c.id}" data-name="${c.name}"> ${c.name}</label>
                </div>
            `).join('');
            
            if (quotaList) quotaList.innerHTML = checkboxHtml || '<span style="color:#999;">暂无配置的K8s集群</span>';
            if (nsQuotaList) nsQuotaList.innerHTML = checkboxHtml || '<span style="color:#999;">暂无配置的K8s集群</span>';
        }
        
        function toggleAllQuotaClusters(checked) {
            const checkboxes = document.querySelectorAll('#quotaK8sClusterList input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = checked);
        }
        
        function toggleAllNsQuotaClusters(checked) {
            const checkboxes = document.querySelectorAll('#nsQuotaK8sClusterList input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = checked);
        }
        
        function editQuota(cloudId, projectName, cpuQuota, memoryQuota) {
            document.getElementById('editCloudId').value = cloudId;
            document.getElementById('editProjectName').value = projectName;
            document.getElementById('editCpuQuota').value = cpuQuota;
            document.getElementById('editMemoryQuota').value = memoryQuota;
            document.getElementById('editModal').classList.remove('hidden');
        }
        
        function closeModal() {
            document.getElementById('editModal').classList.add('hidden');
        }
        
        async function saveQuota() {
            const cloudId = document.getElementById('editCloudId').value;
            const projectName = document.getElementById('editProjectName').value;
            const cpuQuota = parseFloat(document.getElementById('editCpuQuota').value);
            const memoryQuota = parseFloat(document.getElementById('editMemoryQuota').value);
            
            const res = await fetch(`${API_BASE}/quotas/${cloudId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    project_name: projectName,
                    cpu_quota: cpuQuota,
                    memory_quota: memoryQuota
                })
            });
            
            if (res.ok) {
                closeModal();
                loadQuotas();
            } else {
                alert('修改失败');
            }
        }
        
        async function syncProjectQuotaFromK8s() {
            const checkboxes = document.querySelectorAll('#quotaK8sClusterList input[type="checkbox"]:checked');
            if (checkboxes.length === 0) {
                alert('请至少选择一个K8s集群');
                return;
            }
            
            let totalImported = 0;
            let totalUpdated = 0;
            const div = document.getElementById('quotaSyncResult');
            div.innerHTML = '<span style="color:#666;">同步中...</span>';
            
            for (const checkbox of checkboxes) {
                const configId = checkbox.value;
                try {
                    const res = await fetch(`${API_BASE}/k8s/sync-project-quota`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({config_id: configId})
                    });
                    const result = await res.json();
                    totalImported += result.imported || 0;
                    totalUpdated += result.updated || 0;
                } catch (e) {
                    console.error('Sync error:', e);
                }
            }
            
            div.innerHTML = `<div class="alert alert-success">同步完成: 导入 ${totalImported}, 更新 ${totalUpdated}</div>`;
            loadQuotas();
        }
        
        async function syncNsQuotaFromK8s() {
            const checkboxes = document.querySelectorAll('#nsQuotaK8sClusterList input[type="checkbox"]:checked');
            if (checkboxes.length === 0) {
                alert('请至少选择一个K8s集群');
                return;
            }
            
            let totalImported = 0;
            let totalUpdated = 0;
            const div = document.getElementById('nsQuotaSyncResult');
            div.innerHTML = '<span style="color:#666;">同步中...</span>';
            
            for (const checkbox of checkboxes) {
                const configId = checkbox.value;
                const clusterName = checkbox.dataset.name;
                try {
                    const res = await fetch(`${API_BASE}/k8s/sync`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({config_id: configId})
                    });
                    const result = await res.json();
                    totalImported += result.imported || 0;
                    totalUpdated += result.updated || 0;
                } catch (e) {
                    console.error('Sync error:', e);
                }
            }
            
            div.innerHTML = `<div class="alert alert-success">同步完成: 导入 ${totalImported}, 更新 ${totalUpdated}</div>`;
            loadNamespaceQuotas();
        }
        
        async function downloadQuotaTemplate() {
            window.location.href = `${API_BASE}/templates/quota`;
        }
        
        async function downloadReportTemplate() {
            window.location.href = `${API_BASE}/templates/report`;
        }
        
        async function importQuota() {
            const fileInput = document.getElementById('quotaFile');
            if (!fileInput.files[0]) {
                alert('请选择文件');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            const res = await fetch(`${API_BASE}/quotas/import`, {
                method: 'POST',
                body: formData
            });
            const result = await res.json();
            
            const div = document.getElementById('quotaImportResult');
            if (result.success) {
                div.innerHTML = `<div class="alert alert-success">导入成功: 新增${result.imported}条, 更新${result.updated}条</div>`;
                loadQuotas();
            } else {
                div.innerHTML = `<div class="alert alert-error">导入失败: ${result.errors.join(', ')}</div>`;
            }
        }
        
        async function deleteQuota(cloudId) {
            if (!confirm('确定删除?')) return;
            await fetch(`${API_BASE}/quotas/${cloudId}`, { method: 'DELETE' });
            loadQuotas();
        }
        
        // Namespace Quota functions
        async function loadNamespaceQuotas() {
            const cluster = document.getElementById('nsQuotaFilterCluster')?.value || '';
            const url = cluster ? `${API_BASE}/k8s/quotas?cluster=${cluster}` : `${API_BASE}/k8s/quotas`;
            const res = await fetch(url);
            const quotas = await res.json();
            
            const tbody = document.getElementById('nsQuotaTable');
            tbody.innerHTML = quotas.map(q => {
                const cpuRate = q.cpu_limit > 0 ? (q.cpu_used / q.cpu_limit * 100).toFixed(2) : '0';
                const memRate = q.memory_limit > 0 ? (q.memory_used / q.memory_limit * 100).toFixed(2) : '0';
                const podsRate = q.pods_limit > 0 ? (q.pods_used / q.pods_limit * 100).toFixed(2) : '0';
                const storageRate = q.storage_limit > 0 ? (q.storage_used / q.storage_limit * 100).toFixed(2) : '0';
                return `
                    <tr>
                        <td>${q.cluster_name}</td>
                        <td>${q.namespace}</td>
                        <td>${q.project_name || '-'}</td>
                        <td>${q.cpu_limit}</td>
                        <td>${q.cpu_used}</td>
                        <td class="${getRateClass(cpuRate)}">${cpuRate}%</td>
                        <td>${q.memory_limit.toFixed(2)} GB</td>
                        <td>${q.memory_used.toFixed(2)} GB</td>
                        <td class="${getRateClass(memRate)}">${memRate}%</td>
                        <td>${q.pods_limit}</td>
                        <td>${q.pods_used}</td>
                        <td>${q.storage_limit.toFixed(2)} GB</td>
                        <td>${q.storage_used.toFixed(2)} GB</td>
                        <td><button class="btn btn-danger btn-sm" onclick="deleteNsQuota('${q.cluster_name}', '${q.namespace}')">删除</button></td>
                    </tr>
                `;
            }).join('');
            
            // Load cluster options
            const k8sRes = await fetch(`${API_BASE}/k8s/configs`);
            const k8sConfigs = await k8sRes.json();
            const filterSelect = document.getElementById('nsQuotaFilterCluster');
            if (filterSelect) {
                filterSelect.innerHTML = '<option value="">全部</option>' + k8sConfigs.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            }
        }
        
        async function importNsQuota() {
            const fileInput = document.getElementById('nsQuotaFile');
            const file = fileInput.files[0];
            if (!file) {
                alert('请选择文件');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            const res = await fetch(`${API_BASE}/k8s/quotas/import`, {
                method: 'POST',
                body: formData
            });
            const result = await res.json();
            
            const div = document.getElementById('nsQuotaImportResult');
            if (result.success) {
                div.innerHTML = `<div class="alert alert-success">导入成功: ${result.imported} 条</div>`;
                loadNamespaceQuotas();
            } else {
                div.innerHTML = `<div class="alert alert-error">导入失败: ${result.errors?.join(', ')}</div>`;
            }
        }
        
        async function downloadNsQuotaTemplate() {
            window.location.href = `${API_BASE}/templates/namespace-quota`;
        }
        
        async function deleteNsQuota(cluster, namespace) {
            if (!confirm('确定删除?')) return;
            await fetch(`${API_BASE}/k8s/quotas/${cluster}/${namespace}`, { method: 'DELETE' });
            loadNamespaceQuotas();
        }
        
        // Scheduler Config functions
        async function loadSchedulerConfig() {
            const res = await fetch(`${API_BASE}/scheduler/config`);
            const config = await res.json();
            document.getElementById('schedulerEnabled').checked = config.enabled || false;
            document.getElementById('schedulerNsQuotaHour').value = config.namespace_quota_hour || 2;
            document.getElementById('schedulerPrometheusHour').value = config.prometheus_sync_hour || 3;
            document.getElementById('schedulerInterval').value = config.interval_hours || 24;
        }
        
        async function saveSchedulerConfig() {
            const enabled = document.getElementById('schedulerEnabled').checked;
            const namespace_quota_hour = parseInt(document.getElementById('schedulerNsQuotaHour').value);
            const prometheus_sync_hour = parseInt(document.getElementById('schedulerPrometheusHour').value);
            const interval_hours = parseInt(document.getElementById('schedulerInterval').value);
            
            const res = await fetch(`${API_BASE}/scheduler/config?enabled=${enabled}&namespace_quota_hour=${namespace_quota_hour}&prometheus_sync_hour=${prometheus_sync_hour}&interval_hours=${interval_hours}`, {
                method: 'POST'
            });
            
            const result = await res.json();
            const div = document.getElementById('schedulerResult');
            if (result.enabled !== undefined) {
                div.innerHTML = `<div class="alert alert-success">保存成功！</div>`;
            } else {
                div.innerHTML = `<div class="alert alert-error">保存失败</div>`;
            }
        }
        
        const uploadArea = document.getElementById('uploadArea');
        const reportFiles = document.getElementById('reportFiles');
        
        uploadArea.addEventListener('click', () => reportFiles.click());
        uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.classList.add('dragover'); });
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
        uploadArea.addEventListener('drop', e => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleReportUpload(e.dataTransfer.files);
        });
        reportFiles.addEventListener('change', () => handleReportUpload(reportFiles.files));
        
        async function handleReportUpload(files) {
            const formData = new FormData();
            for (const file of files) {
                formData.append('files', file);
            }
            
            const res = await fetch(`${API_BASE}/reports/upload`, {
                method: 'POST',
                body: formData
            });
            const result = await res.json();
            
            const div = document.getElementById('uploadResult');
            if (result.errors.length > 0) {
                div.innerHTML = `<div class="alert alert-error">上传出错: ${result.errors.join(', ')}</div>`;
            } else {
                const uploadInfo = result.uploaded.map(u => `${u.filename} -> ${u.date} (${u.record_count}条)`).join('<br>');
                div.innerHTML = `<div class="alert alert-success">上传成功: <br>${uploadInfo}</div>`;
            }
            
            loadReports();
        }
        
        async function loadReports() {
            const res = await fetch(`${API_BASE}/reports`);
            const reports = await res.json();
            const div = document.getElementById('reportList');
            div.innerHTML = reports.length ? 
                reports.map(r => `<div class="checkbox-item">${r.date} (${r.record_count}条记录)</div>`).join('') :
                '<p style="color: #999;">暂无日报数据</p>';
        }
        
        async function loadViewDates() {
            const res = await fetch(`${API_BASE}/reports`);
            const reports = await res.json();
            const select = document.getElementById('viewDateSelect');
            select.innerHTML = '<option value="">请选择日期</option>' + 
                reports.map(r => `<option value="${r.date}">${r.date}</option>`).join('');
        }
        
        async function loadReport() {
            const date = document.getElementById('viewDateSelect').value;
            if (!date) {
                document.getElementById('reportTable').innerHTML = '';
                return;
            }
            
            const res = await fetch(`${API_BASE}/reports/${date}`);
            const usages = await res.json();
            
            const tbody = document.getElementById('reportTable');
            tbody.innerHTML = usages.map(u => {
                const cpuRate = u.cpu_rate ? u.cpu_rate.toFixed(2) : '-';
                const memRate = u.memory_rate ? u.memory_rate.toFixed(2) : '-';
                return `
                    <tr>
                        <td>${u.cloud_id || '-'}</td>
                        <td>${u.project_name}</td>
                        <td>${u.cpu_usage.toFixed(2)}</td>
                        <td>${u.memory_usage.toFixed(2)}</td>
                        <td class="${getRateClass(u.cpu_rate)}">${cpuRate}%</td>
                        <td class="${getRateClass(u.memory_rate)}">${memRate}%</td>
                    </tr>
                `;
            }).join('');
        }
        
        function getRateClass(rate) {
            if (rate === null || rate === undefined) return '';
            if (rate >= 80) return 'rate-high';
            if (rate >= 50) return 'rate-medium';
            return 'rate-low';
        }
        
        async function loadExportDates() {
            const res = await fetch(`${API_BASE}/reports`);
            const reports = await res.json();
            const div = document.getElementById('exportDateList');
            div.innerHTML = reports.length ?
                reports.map(r => `
                    <div class="checkbox-item">
                        <label><input type="checkbox" value="${r.date}"> ${r.date}</label>
                    </div>
                `).join('') :
                '<p style="color: #999;">暂无可导出的数据</p>';
        }
        
        function toggleAllExportDates(checked) {
            const checkboxes = document.querySelectorAll('#exportDateList input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = checked);
        }
        
        async function exportReport() {
            const checkboxes = document.querySelectorAll('#exportDateList input:checked');
            const dates = Array.from(checkboxes).map(c => c.value);
            
            if (dates.length === 0) {
                alert('请选择至少一个日期');
                return;
            }
            
            window.location.href = `${API_BASE}/reports/export?dates=${dates.join(',')}`;
        }
        
        // K8s Config Tab
        async function loadK8sConfigs() {
            const res = await fetch(`${API_BASE}/k8s/configs`);
            const configs = await res.json();
            const tbody = document.getElementById('k8sConfigTable');
            tbody.innerHTML = configs.map(c => `
                <tr>
                    <td>${c.name}</td>
                    <td>${c.use_projectquota ? 'ProjectQuota' : 'Namespace Quota'}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteK8sConfig('${c.id}')">删除</button>
                    </td>
                </tr>
            `).join('');
        }
        
        async function addK8sConfig() {
            const name = document.getElementById('k8sName').value;
            const kubeconfig = document.getElementById('k8sKubeconfig').value;
            const use_projectquota = document.getElementById('k8sUseProjectQuota').checked;
            
            if (!name || !kubeconfig) {
                alert('请填写完整信息');
                return;
            }
            
            const res = await fetch(`${API_BASE}/k8s/configs`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name, kubeconfig, use_projectquota})
            });
            
            if (res.ok) {
                document.getElementById('k8sName').value = '';
                document.getElementById('k8sKubeconfig').value = '';
                loadK8sConfigs();
            } else {
                alert('添加失败');
            }
        }
        
        async function syncK8sConfig(id) {
            const res = await fetch(`${API_BASE}/k8s/sync`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({config_id: id})
            });
            const result = await res.json();
            alert(`同步完成: 导入 ${result.imported}, 更新 ${result.updated}`);
        }
        
        async function syncProjectQuota(id) {
            const res = await fetch(`${API_BASE}/k8s/sync-project-quota`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({config_id: id})
            });
            const result = await res.json();
            alert(`同步项目配额完成: 导入 ${result.imported}, 更新 ${result.updated}`);
        }
        
        async function deleteK8sConfig(id) {
            if (!confirm('确定删除?')) return;
            await fetch(`${API_BASE}/k8s/configs/${id}`, {method: 'DELETE'});
            loadK8sConfigs();
        }
        
        async function importK8sConfigs() {
            const fileInput = document.getElementById('k8sImportFile');
            const file = fileInput.files[0];
            if (!file) {
                alert('请选择文件');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            const res = await fetch(`${API_BASE}/k8s/configs/import`, {
                method: 'POST',
                body: formData
            });
            const result = await res.json();
            
            const div = document.getElementById('k8sImportResult');
            if (result.success) {
                div.innerHTML = `<div class="alert alert-success">导入成功: ${result.imported} 条</div>`;
                loadK8sConfigs();
            } else {
                div.innerHTML = `<div class="alert alert-error">导入失败: ${result.errors?.join(', ')}</div>`;
            }
        }
        
        async function downloadK8sTemplate() {
            window.location.href = `${API_BASE}/templates/k8s-config`;
        }
        
        // Prometheus Config Tab
        async function loadPrometheusConfigs() {
            const res = await fetch(`${API_BASE}/prometheus/configs`);
            const configs = await res.json();
            const tbody = document.getElementById('prometheusConfigTable');
            tbody.innerHTML = configs.map(c => `
                <tr>
                    <td>${c.name}</td>
                    <td>${c.url}</td>
                    <td>${c.cluster_name}</td>
                    <td>${c.use_accurate_sync ? '精确同步' : '普通'}</td>
                    <td>
                        <button class="btn btn-success btn-sm" onclick="syncPrometheusConfig('${c.id}')">同步</button>
                        <button class="btn btn-danger btn-sm" onclick="deletePrometheusConfig('${c.id}')">删除</button>
                    </td>
                </tr>
            `).join('');
        }
        
        async function addPrometheusConfig() {
            const name = document.getElementById('prometheusName').value;
            const url = document.getElementById('prometheusUrl').value;
            const cluster_name = document.getElementById('prometheusCluster').value;
            const use_accurate_sync = document.getElementById('prometheusAccurate').checked;
            
            if (!name || !url || !cluster_name) {
                alert('请填写完整信息');
                return;
            }
            
            const res = await fetch(`${API_BASE}/prometheus/configs`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name, url, cluster_name, use_accurate_sync})
            });
            
            if (res.ok) {
                document.getElementById('prometheusName').value = '';
                document.getElementById('prometheusUrl').value = '';
                document.getElementById('prometheusCluster').value = '';
                loadPrometheusConfigs();
            } else {
                alert('添加失败');
            }
        }
        
        async function syncPrometheusConfig(id) {
            const res = await fetch(`${API_BASE}/prometheus/sync?config_id=${id}`, {
                method: 'POST'
            });
            const result = await res.json();
            alert(`同步完成: 导入 ${result.imported}, 更新 ${result.updated}`);
        }
        
        async function deletePrometheusConfig(id) {
            if (!confirm('确定删除?')) return;
            await fetch(`${API_BASE}/prometheus/configs/${id}`, {method: 'DELETE'});
            loadPrometheusConfigs();
        }
        
        async function importPrometheusConfigs() {
            const fileInput = document.getElementById('prometheusImportFile');
            const file = fileInput.files[0];
            if (!file) {
                alert('请选择文件');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            const res = await fetch(`${API_BASE}/prometheus/import`, {
                method: 'POST',
                body: formData
            });
            const result = await res.json();
            
            const div = document.getElementById('prometheusImportResult');
            if (result.success) {
                div.innerHTML = `<div class="alert alert-success">导入成功: ${result.imported} 条</div>`;
                loadPrometheusConfigs();
            } else {
                div.innerHTML = `<div class="alert alert-error">导入失败: ${result.errors?.join(', ')}</div>`;
            }
        }
        
        async function downloadPrometheusTemplate() {
            window.location.href = `${API_BASE}/templates/prometheus-config`;
        }
        
        loadQuotas();
    </script>
</body>
</html>
