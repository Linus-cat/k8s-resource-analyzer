# K8s资源使用率分析工具 - 开发会话记录

## 会话概述

- **项目**: K8s集群资源使用率统计分析工具
- **作者**: 骆玉宝 (ybluo@alauda.io)
- **技术栈**: Python 3.10 + FastAPI + openpyxl
- **开发工具**: OpenCode (big-pickle模型)

---

## 开发历程

### 第一阶段：基础功能开发

1. **项目配额管理**
   - 支持Excel导入项目配额
   - 手动添加/修改/删除配额
   - 下载模板功能

2. **日报上传与解析**
   - 支持文件拖拽上传
   - 多文件批量上传
   - 自动解析日期和内容

3. **报表查看**
   - 按日期筛选
   - CPU/内存使用率显示
   - 颜色区分（高/中/低）

4. **Excel导出**
   - 支持多日期导出
   - 表头：云序号、日期、cpu使用率、内存使用率

### 第二阶段：K8s与Prometheus集成

1. **K8s接入功能**
   - 添加K8s集群配置（kubeconfig）
   - 支持ProjectQuota和Namespace ResourceQuota
   - 同步项目配额、命名空间配额

2. **Prometheus接入**
   - 配置Prometheus URL
   - 关联K8s集群
   - 精确同步模式（副本数去重）

3. **准确数据同步**
   - 根据副本数去重处理滚动更新
   - CPU查询：irate + max_over_time
   - 内存查询：container_memory_usage_bytes

### 第三阶段：功能完善

1. **批量导入**
   - K8s集群批量导入
   - Prometheus配置批量导入
   - 命名空间配额批量导入
   - 下载模板功能

2. **定时任务**
   - 定时同步K8s配额
   - 定时同步Prometheus数据
   - 可配置同步时间

3. **界面优化**
   - 所有菜单添加tooltip说明
   - PromQL规则说明
   - 全选功能

### 第四阶段：文档更新

1. **开发文档更新**
   - 1.0.0 → 1.1.0
   - 新增功能说明
   - API文档完善
   - 后续优化计划

---

## 功能清单

| 功能 | 状态 |
|------|------|
| 项目配额管理 | ✅ |
| 命名空间配额管理 | ✅ |
| 多K8s集群支持 | ✅ |
| 多Prometheus支持 | ✅ |
| 准确数据同步 | ✅ |
| 日报上传解析 | ✅ |
| 报表查看 | ✅ |
| Excel导出(10位小数) | ✅ |
| 定时任务 | ✅ |
| 批量导入/导出模板 | ✅ |
| 菜单tooltip | ✅ |
| PromQL说明 | ✅ |
| 全选功能 | ✅ |
| 开发文档(PDF/HTML/DOCX) | ✅ |

---

## API接口

### 配额管理
- GET/POST /api/quotas
- PUT/DELETE /api/quotas/{cloud_id}
- POST /api/quotas/import

### K8s集群
- GET/POST /api/k8s/configs
- DELETE /api/k8s/configs/{id}
- POST /api/k8s/sync
- POST /api/k8s/sync-project-quota
- POST /api/k8s/configs/import

### 命名空间配额
- GET /api/k8s/quotas
- DELETE /api/k8s/quotas/{cluster}/{namespace}
- POST /api/k8s/quotas/import

### Prometheus
- GET/POST /api/prometheus/configs
- DELETE /api/prometheus/configs/{id}
- POST /api/prometheus/sync
- POST /api/prometheus/import

### 定时任务
- GET/POST /api/scheduler/config

### 模板下载
- GET /api/templates/quota
- GET /api/templates/report
- GET /api/templates/namespace-quota
- GET /api/templates/k8s-config
- GET /api/templates/prometheus-config

---

## 文件结构

```
k8s-resource-analyzer/
├── app/
│   ├── main.py               # FastAPI入口
│   ├── models.py             # 数据模型
│   ├── storage.py            # 存储（配额/配置）
│   ├── parser.py             # 日报解析
│   ├── quota_manager.py      # 配额管理
│   ├── calculator.py         # 使用率计算
│   ├── exporter.py           # Excel导出
│   ├── k8s_client.py        # K8s API客户端
│   ├── prometheus_client.py  # Prometheus客户端
│   └── scheduler.py          # 定时任务
├── templates/
│   └── index.html            # 前端页面
├── docs/
│   ├── 开发文档.md            # Markdown文档
│   ├── 开发文档.html          # HTML文档
│   ├── K8s资源使用率分析工具_开发文档.pdf
│   └── K8s资源使用率分析工具_开发文档.docx
└── README.md
```

---

## 后续优化计划

1. 数据持久化（SQLite/PostgreSQL）
2. 用户认证与权限管理
3. 告警功能
4. 历史趋势与可视化
5. 多租户支持
6. API开放
7. 监控与日志

---

## GitHub

https://github.com/Linus-cat/k8s-resource-analyzer

---

*本文档由OpenCode辅助生成*
