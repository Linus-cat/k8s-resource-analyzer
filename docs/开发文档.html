<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>K8s资源使用率分析工具 - 开发文档</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; line-height: 1.6; }
        h1, h2, h3 { color: #333; }
        code { background: #f4f4f4; padding: 2px 6px; border-radius: 3px; }
        pre { background: #f4f4f4; padding: 15px; border-radius: 5px; overflow-x: auto; }
        table { border-collapse: collapse; width: 100%; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f4f4f4; }
    </style>
</head>
<body>
<h1>K8s集群资源使用率统计分析工具 - 开发文档</h1>
<h2>文档信息</h2>
<ul>
<li><strong>版本</strong>: 1.1.0</li>
<li><strong>创建日期</strong>: 2026-02-25</li>
<li><strong>更新日期</strong>: 2026-02-26</li>
<li><strong>技术栈</strong>: Python 3.10 + FastAPI + openpyxl</li>
<li><strong>作者</strong>: 骆玉宝</li>
<li><strong>邮箱</strong>: ybluo@alauda.io</li>
<li><strong>GitHub</strong>: https://github.com/Linus-cat/k8s-resource-analyzer</li>
<li><strong>使用AI工具</strong>: OpenCode</li>
</ul>
<hr />
<h2>1. 项目概述</h2>
<h3>1.1 背景与目标</h3>
<p>随着Kubernetes集群规模的不断扩大，对集群资源使用情况进行有效监控和分析变得尤为重要。本工具旨在实现多集群、多维度的资源使用数据自动化统计与分析，支撑项目级资源配额使用率的日常监控与管理。</p>
<h3>1.2 核心功能</h3>
<ol>
<li><strong>项目配额管理</strong>：项目级CPU、内存配额配置，支持手动导入和K8s同步</li>
<li><strong>命名空间配额管理</strong>：K8s命名空间级资源配额（CPU、内存、Pod、存储）</li>
<li><strong>多K8s集群支持</strong>：可配置多个K8s集群，统一管理</li>
<li><strong>多Prometheus支持</strong>：可配置多个Prometheus实例</li>
<li><strong>准确数据同步</strong>：基于副本数去重的精确同步，适合滚动更新场景</li>
<li><strong>日报数据解析</strong>：从文件读取各命名空间的CPU、内存使用数据</li>
<li><strong>使用率计算</strong>：按项目汇总资源使用量，结合配额计算使用率</li>
<li><strong>Excel导出</strong>：生成标准化报告，支持多日期导出</li>
<li><strong>定时任务</strong>：自动同步K8s配额和Prometheus数据</li>
</ol>
<hr />
<h2>2. 系统架构</h2>
<h3>2.1 技术架构</h3>
<pre><code>┌─────────────────────────────────────────────────────────┐
│                    Web浏览器 (前端)                       │
│              HTML + JavaScript (Jinja2)                  │
│              Bootstrap UI + AJAX异步交互                   │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│                   FastAPI (后端服务)                      │
│   ┌─────────────┐ ┌─────────────┐ ┌─────────────┐      │
│   │  配额管理   │ │  日报处理   │ │   Excel导出  │      │
│   │ (项目/命名空间)│ │           │ │             │      │
│   └─────────────┘ └─────────────┘ └─────────────┘      │
│   ┌─────────────┐ ┌─────────────┐ ┌─────────────┐      │
│   │ K8s客户端   │ │ Prometheus  │ │  定时任务   │      │
│   │             │ │   客户端    │ │             │      │
│   └─────────────┘ └─────────────┘ └─────────────┘      │
└─────────────────────────────────────────────────────────┘
                           │
        ┌──────────────────┼──────────────────┐
        ▼                  ▼                  ▼
  ┌───────────┐     ┌───────────┐     ┌───────────┐
  │ JSON存储  │     │  内存缓存  │     │  openpyxl │
  │(多文件)   │     │(ReportCache)│    │  Excel处理 │
  └───────────┘     └───────────┘     └───────────┘
</code></pre>
<h3>2.2 项目结构</h3>
<pre><code>k8s-resource-analyzer/
├── app/
│   ├── __init__.py           # 包初始化
│   ├── main.py               # FastAPI入口、路由定义
│   ├── models.py             # Pydantic数据模型
│   ├── storage.py            # JSON存储（配额/配置）
│   ├── parser.py             # 日报文件解析器
│   ├── quota_manager.py      # 配额管理（CRUD+Excel导入）
│   ├── calculator.py         # 使用率计算逻辑
│   ├── exporter.py           # Excel导出功能
│   ├── k8s_client.py         # K8s API客户端
│   ├── prometheus_client.py  # Prometheus客户端
│   └── scheduler.py          # 定时任务调度器
├── templates/
│   └── index.html            # 前端页面（多Tab界面）
├── data/                     # 数据存储目录
│   ├── quotas.json           # 项目配额
│   ├── k8s_configs.json     # K8s集群配置
│   ├── prometheus_configs.json # Prometheus配置
│   ├── namespace_quotas.json # 命名空间配额
│   └── scheduler_config.json # 定时任务配置
├── uploads/                  # 上传文件临时目录
├── requirements.txt         # Python依赖
└── README.md                # 项目说明
</code></pre>
<hr />
<h2>3. 安装与运行</h2>
<h3>3.1 环境要求</h3>
<ul>
<li>Python 3.10+</li>
<li>pip 包管理器</li>
</ul>
<h3>3.2 安装步骤</h3>
<pre><code class="language-bash"># 1. 进入项目目录
cd k8s-resource-analyzer

# 2. 安装依赖
pip install -r requirements.txt

# 3. 启动服务
python -m app.main
# 或
uvicorn app.main:app --host 0.0.0.0 --port 8000
</code></pre>
<h3>3.3 访问方式</h3>
<ul>
<li>本地访问：http://localhost:8000</li>
<li>局域网访问：http://&lt;服务器IP&gt;:8000</li>
</ul>
<hr />
<h2>4. 功能说明</h2>
<h3>4.1 菜单功能总览</h3>
<table>
<thead>
<tr>
<th>菜单</th>
<th>功能说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>项目配额管理</td>
<td>管理项目级配额，支持K8s同步、手动导入Excel、批量操作</td>
</tr>
<tr>
<td>命名空间配额</td>
<td>管理命名空间级配额，显示CPU/内存/Pod/存储等资源限制和已使用量</td>
</tr>
<tr>
<td>日报上传</td>
<td>上传日报文件，系统解析并计算项目资源使用率</td>
</tr>
<tr>
<td>报表查看</td>
<td>查看已上传的日报数据，按日期筛选</td>
</tr>
<tr>
<td>导出</td>
<td>选择多个日期，导出Excel报告</td>
</tr>
<tr>
<td>定时任务</td>
<td>配置自动同步任务的时间和间隔</td>
</tr>
<tr>
<td>K8s接入</td>
<td>配置K8s集群连接信息，支持批量导入多个集群</td>
</tr>
<tr>
<td>Prometheus接入</td>
<td>配置Prometheus连接，支持批量导入多个实例</td>
</tr>
</tbody>
</table>
<h3>4.2 项目配额管理</h3>
<h4>4.2.1 K8s同步</h4>
<ul>
<li>选择已接入的K8s集群（支持全选）</li>
<li>点击"同步项目配额"从K8s获取ProjectQuota数据</li>
<li>支持批量同步多个集群</li>
</ul>
<h4>4.2.2 手动导入</h4>
<ul>
<li>下载模板，格式：云序号、项目名称、CPU配额、内存配额</li>
<li>支持增量导入</li>
</ul>
<h3>4.3 命名空间配额</h3>
<ul>
<li>显示所有命名空间的资源限制和已使用量</li>
<li>CPU、内存、Pod数、存储使用量及使用率</li>
<li>支持按集群筛选</li>
</ul>
<h3>4.4 K8s接入</h3>
<ul>
<li>添加K8s集群配置（集群名称、Kubeconfig）</li>
<li>支持ProjectQuota或Namespace ResourceQuota</li>
<li>批量导入多个集群配置</li>
<li>下载配置模板</li>
</ul>
<h3>4.5 Prometheus接入</h3>
<ul>
<li>添加Prometheus配置（名称、URL、关联集群）</li>
<li>支持精确同步模式（根据副本数去重）</li>
<li>批量导入多个Prometheus配置</li>
</ul>
<h3>4.6 定时任务</h3>
<ul>
<li>启用/禁用定时任务</li>
<li>配置命名空间配额同步时间</li>
<li>配置Prometheus同步时间</li>
<li>配置同步间隔</li>
</ul>
<h3>4.7 数据导出</h3>
<ul>
<li>选择日期（支持全选）</li>
<li>导出格式：主键/周期/CPU利用率/内存利用率</li>
<li>使用率保留10位小数</li>
</ul>
<hr />
<h2>5. API接口文档</h2>
<h3>5.1 项目配额管理</h3>
<table>
<thead>
<tr>
<th>方法</th>
<th>路径</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>/api/quotas</td>
<td>获取所有配额列表</td>
</tr>
<tr>
<td>POST</td>
<td>/api/quotas</td>
<td>添加单个配额</td>
</tr>
<tr>
<td>PUT</td>
<td>/api/quotas/{cloud_id}</td>
<td>修改配额</td>
</tr>
<tr>
<td>DELETE</td>
<td>/api/quotas/{cloud_id}</td>
<td>删除配额</td>
</tr>
<tr>
<td>POST</td>
<td>/api/quotas/import</td>
<td>Excel导入配额</td>
</tr>
</tbody>
</table>
<h3>5.2 K8s集群管理</h3>
<table>
<thead>
<tr>
<th>方法</th>
<th>路径</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>/api/k8s/configs</td>
<td>获取K8s配置列表</td>
</tr>
<tr>
<td>POST</td>
<td>/api/k8s/configs</td>
<td>添加K8s配置</td>
</tr>
<tr>
<td>DELETE</td>
<td>/api/k8s/configs/{id}</td>
<td>删除K8s配置</td>
</tr>
<tr>
<td>POST</td>
<td>/api/k8s/sync</td>
<td>同步命名空间配额</td>
</tr>
<tr>
<td>POST</td>
<td>/api/k8s/sync-project-quota</td>
<td>同步项目配额</td>
</tr>
<tr>
<td>POST</td>
<td>/api/k8s/configs/import</td>
<td>批量导入K8s配置</td>
</tr>
</tbody>
</table>
<h3>5.3 命名空间配额</h3>
<table>
<thead>
<tr>
<th>方法</th>
<th>路径</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>/api/k8s/quotas</td>
<td>获取命名空间配额列表</td>
</tr>
<tr>
<td>DELETE</td>
<td>/api/k8s/quotas/{cluster}/{namespace}</td>
<td>删除命名空间配额</td>
</tr>
<tr>
<td>POST</td>
<td>/api/k8s/quotas/import</td>
<td>批量导入命名空间配额</td>
</tr>
</tbody>
</table>
<h3>5.4 Prometheus管理</h3>
<table>
<thead>
<tr>
<th>方法</th>
<th>路径</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>/api/prometheus/configs</td>
<td>获取Prometheus配置列表</td>
</tr>
<tr>
<td>POST</td>
<td>/api/prometheus/configs</td>
<td>添加Prometheus配置</td>
</tr>
<tr>
<td>DELETE</td>
<td>/api/prometheus/configs/{id}</td>
<td>删除Prometheus配置</td>
</tr>
<tr>
<td>POST</td>
<td>/api/prometheus/sync</td>
<td>同步Prometheus数据</td>
</tr>
<tr>
<td>POST</td>
<td>/api/prometheus/import</td>
<td>批量导入Prometheus配置</td>
</tr>
</tbody>
</table>
<h3>5.5 定时任务</h3>
<table>
<thead>
<tr>
<th>方法</th>
<th>路径</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>/api/scheduler/config</td>
<td>获取定时任务配置</td>
</tr>
<tr>
<td>POST</td>
<td>/api/scheduler/config</td>
<td>更新定时任务配置</td>
</tr>
</tbody>
</table>
<h3>5.6 日报与导出</h3>
<table>
<thead>
<tr>
<th>方法</th>
<th>路径</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>POST</td>
<td>/api/reports/upload</td>
<td>上传日报文件</td>
</tr>
<tr>
<td>GET</td>
<td>/api/reports</td>
<td>获取已上传日期列表</td>
</tr>
<tr>
<td>GET</td>
<td>/api/reports/{date}</td>
<td>获取指定日期数据</td>
</tr>
<tr>
<td>GET</td>
<td>/api/reports/export</td>
<td>导出Excel报告</td>
</tr>
</tbody>
</table>
<h3>5.7 模板下载</h3>
<table>
<thead>
<tr>
<th>方法</th>
<th>路径</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>/api/templates/quota</td>
<td>下载项目配额模板</td>
</tr>
<tr>
<td>GET</td>
<td>/api/templates/report</td>
<td>下载日报模板</td>
</tr>
<tr>
<td>GET</td>
<td>/api/templates/namespace-quota</td>
<td>下载命名空间配额模板</td>
</tr>
<tr>
<td>GET</td>
<td>/api/templates/k8s-config</td>
<td>下载K8s配置模板</td>
</tr>
<tr>
<td>GET</td>
<td>/api/templates/prometheus-config</td>
<td>下载Prometheus配置模板</td>
</tr>
</tbody>
</table>
<hr />
<h2>6. 核心模块说明</h2>
<h3>6.1 k8s_client.py - K8s API客户端</h3>
<ul>
<li>解析kubeconfig配置</li>
<li>调用Kubernetes API获取命名空间、资源配额</li>
<li>获取资源</li>
<li>获取ProjectQuota自定义Workload副本数（用于精确同步）</li>
</ul>
<h3>6.2 prometheus_client.py - Prometheus客户端</h3>
<ul>
<li>查询CPU/内存使用量</li>
<li>精确同步模式：根据副本数去重处理滚动更新</li>
<li>PromQL规则：</li>
<li>CPU：<code>sum(max by (pod)(max_over_time(irate(container_cpu_usage_seconds_total[5m])[1d:])))</code></li>
<li>内存：<code>sum(max by (pod)(max_over_time(container_memory_usage_bytes[1d])))</code></li>
</ul>
<h3>6.3 scheduler.py - 定时任务</h3>
<ul>
<li>定时同步K8s命名空间配额</li>
<li>定时同步Prometheus使用数据</li>
<li>可配置同步时间</li>
</ul>
<hr />
<h2>7. 部署建议</h2>
<h3>7.1 开发环境</h3>
<pre><code class="language-bash">pip install -r requirements.txt
python -m app.main
</code></pre>
<h3>7.2 生产环境</h3>
<pre><code class="language-bash"># 使用Gunicorn替代uvicorn
pip install gunicorn
gunicorn -w 4 -k uvicorn.workers.UvicornWorker app.main:app --bind 0.0.0.0:8000
</code></pre>
<h3>7.3 Docker部署</h3>
<pre><code class="language-dockerfile">FROM python:3.10-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

EXPOSE 8000

CMD [&quot;uvicorn&quot;, &quot;app.main:app&quot;, &quot;--host&quot;, &quot;0.0.0.0&quot;, &quot;--port&quot;, &quot;8000&quot;]
</code></pre>
<pre><code class="language-bash">docker build -t k8s-resource-analyzer .
docker run -d -p 8000:8000 -v ./data:/app/data k8s-resource-analyzer
</code></pre>
<hr />
<h2>8. 后续优化与功能添加计划</h2>
<h3>8.1 数据持久化</h3>
<p><strong>优先级</strong>: 高</p>
<p><strong>目标</strong>: 从JSON文件存储改为SQLite/PostgreSQL数据库</p>
<p><strong>收益</strong>:
- 支持更大数据量
- 提高并发性能
- 支持数据备份和迁移</p>
<h3>8.2 用户认证与权限管理</h3>
<p><strong>优先级</strong>: 中</p>
<p><strong>目标</strong>: 增加登录功能，支持多用户和角色权限</p>
<p><strong>功能</strong>:
- 用户注册/登录（JWT认证）
- 角色：管理员、普通用户
- 管理员可管理所有配置
- 普通用户只能查看和导出</p>
<h3>8.3 告警功能</h3>
<p><strong>优先级</strong>: 中</p>
<p><strong>目标</strong>: 使用率超过阈值时发送通知</p>
<p><strong>通知方式</strong>:
- 邮件通知
- 钉钉/企业微信机器人
- Slack Webhook</p>
<h3>8.4 历史趋势与可视化</h3>
<p><strong>优先级</strong>: 中</p>
<p><strong>目标</strong>: 展示历史使用率变化趋势</p>
<p><strong>功能</strong>:
- 使用ECharts绘制趋势图
- 按周/月/年汇总
- 对比不同项目/集群的使用率</p>
<h3>8.5 多租户支持</h3>
<p><strong>优先级</strong>: 低</p>
<p><strong>目标</strong>: 支持多个独立租户使用</p>
<p><strong>功能</strong>:
- 租户隔离
- 独立配额和配置
- 租户管理员</p>
<h3>8.6 API开放</h3>
<p><strong>优先级</strong>: 低</p>
<p><strong>目标</strong>: 提供RESTful API供其他系统集成</p>
<p><strong>功能</strong>:
- 配额查询API
- 使用率查询API
- 导出API
- 集成文档（Swagger）</p>
<h3>8.7 监控与日志</h3>
<p><strong>优先级</strong>: 低</p>
<p><strong>目标</strong>: 完善系统监控和日志记录</p>
<p><strong>功能</strong>:
- 请求日志
- 错误追踪
- 性能监控（Prometheus metrics）
- 健康检查接口</p>
<hr />
<h2>9. 附录</h2>
<h3>9.1 依赖清单</h3>
<pre><code>fastapi==0.109.0
uvicorn==0.27.0
openpyxl==3.1.2
python-multipart==0.0.6
pydantic==2.5.3
jinja2==3.1.3
pyyaml==6.0.1
</code></pre>
<h3>9.2 常见问题</h3>
<p><strong>Q1: 导出时提示"Report not found"</strong>
A: 确保已上传日报文件，且该日期有匹配配额的項目。</p>
<p><strong>Q2: 上传文件解析失败</strong>
A: 检查文件格式是否符合要求，每行格式为：<code>项目名称;命名空间;CPU;内存(bytes)</code></p>
<p><strong>Q3: 使用率显示为空</strong>
A: 确保配额中的项目名称与日报中的项目名称完全匹配。</p>
<p><strong>Q4: K8s同步失败</strong>
A: 检查kubeconfig是否正确，确保API Server可访问。</p>
<p><strong>Q5: Prometheus同步失败</strong>
A: 检查Prometheus URL是否可访问，确认查询语句正确。</p>
<hr />
<p><strong>文档结束</strong></p>
</body>
</html>